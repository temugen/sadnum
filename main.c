#include <pthread.h>
#include <stdio.h>
#include <stdint.h>

//#define PRECOMPUTED

#define NUM_THREADS 20
#define MAX_WORK 10000000
#define THREAD_WORK (MAX_WORK / NUM_THREADS)

unsigned int sums_of_squares[] = {0, 1, 4, 9, 16, 25, 36, 49, 64, 81, 1, 2, 5, 10, 17,
    26, 37, 50, 65, 82, 4, 5, 8, 13, 20, 29, 40, 53, 68, 85, 9, 10, 13, 18,
    25, 34, 45, 58, 73, 90, 16, 17, 20, 25, 32, 41, 52, 65, 80, 97, 25, 26,
    29, 34, 41, 50, 61, 74, 89, 106, 36, 37, 40, 45, 52, 61, 72, 85, 100, 117,
    49, 50, 53, 58, 65, 74, 85, 98, 113, 130, 64, 65, 68, 73, 80, 89, 100,
    113, 128, 145, 81, 82, 85, 90, 97, 106, 117, 130, 145, 162, 1, 2, 5, 10,
    17, 26, 37, 50, 65, 82, 2, 3, 6, 11, 18, 27, 38, 51, 66, 83, 5, 6, 9, 14,
    21, 30, 41, 54, 69, 86, 10, 11, 14, 19, 26, 35, 46, 59, 74, 91, 17, 18,
    21, 26, 33, 42, 53, 66, 81, 98, 26, 27, 30, 35, 42, 51, 62, 75, 90, 107,
    37, 38, 41, 46, 53, 62, 73, 86, 101, 118, 50, 51, 54, 59, 66, 75, 86, 99,
    114, 131, 65, 66, 69, 74, 81, 90, 101, 114, 129, 146, 82, 83, 86, 91, 98,
    107, 118, 131, 146, 163, 4, 5, 8, 13, 20, 29, 40, 53, 68, 85, 5, 6, 9, 14,
    21, 30, 41, 54, 69, 86, 8, 9, 12, 17, 24, 33, 44, 57, 72, 89, 13, 14, 17,
    22, 29, 38, 49, 62, 77, 94, 20, 21, 24, 29, 36, 45, 56, 69, 84, 101, 29,
    30, 33, 38, 45, 54, 65, 78, 93, 110, 40, 41, 44, 49, 56, 65, 76, 89, 104,
    121, 53, 54, 57, 62, 69, 78, 89, 102, 117, 134, 68, 69, 72, 77, 84, 93,
    104, 117, 132, 149, 85, 86, 89, 94, 101, 110, 121, 134, 149, 166, 9, 10,
    13, 18, 25, 34, 45, 58, 73, 90, 10, 11, 14, 19, 26, 35, 46, 59, 74, 91,
    13, 14, 17, 22, 29, 38, 49, 62, 77, 94, 18, 19, 22, 27, 34, 43, 54, 67,
    82, 99, 25, 26, 29, 34, 41, 50, 61, 74, 89, 106, 34, 35, 38, 43, 50, 59,
    70, 83, 98, 115, 45, 46, 49, 54, 61, 70, 81, 94, 109, 126, 58, 59, 62, 67,
    74, 83, 94, 107, 122, 139, 73, 74, 77, 82, 89, 98, 109, 122, 137, 154, 90,
    91, 94, 99, 106, 115, 126, 139, 154, 171, 16, 17, 20, 25, 32, 41, 52, 65,
    80, 97, 17, 18, 21, 26, 33, 42, 53, 66, 81, 98, 20, 21, 24, 29, 36, 45,
    56, 69, 84, 101, 25, 26, 29, 34, 41, 50, 61, 74, 89, 106, 32, 33, 36, 41,
    48, 57, 68, 81, 96, 113, 41, 42, 45, 50, 57, 66, 77, 90, 105, 122, 52, 53,
    56, 61, 68, 77, 88, 101, 116, 133, 65, 66, 69, 74, 81, 90, 101, 114, 129,
    146, 80, 81, 84, 89, 96, 105, 116, 129, 144, 161, 97, 98, 101, 106, 113,
    122, 133, 146, 161, 178, 25, 26, 29, 34, 41, 50, 61, 74, 89, 106, 26, 27,
    30, 35, 42, 51, 62, 75, 90, 107, 29, 30, 33, 38, 45, 54, 65, 78, 93, 110,
    34, 35, 38, 43, 50, 59, 70, 83, 98, 115, 41, 42, 45, 50, 57, 66, 77, 90,
    105, 122, 50, 51, 54, 59, 66, 75, 86, 99, 114, 131, 61, 62, 65, 70, 77,
    86, 97, 110, 125, 142, 74, 75, 78, 83, 90, 99, 110, 123, 138, 155, 89, 90,
    93, 98, 105, 114, 125, 138, 153, 170, 106, 107, 110, 115, 122, 131, 142,
    155, 170, 187, 36, 37, 40, 45, 52, 61, 72, 85, 100, 117, 37, 38, 41, 46,
    53, 62, 73, 86, 101, 118, 40, 41, 44, 49, 56, 65, 76, 89, 104, 121, 45,
    46, 49, 54, 61, 70, 81, 94, 109, 126, 52, 53, 56, 61, 68, 77, 88, 101,
    116, 133, 61, 62, 65, 70, 77, 86, 97, 110, 125, 142, 72, 73, 76, 81, 88,
    97, 108, 121, 136, 153, 85, 86, 89, 94, 101, 110, 121, 134, 149, 166, 100,
    101, 104, 109, 116, 125, 136, 149, 164, 181, 117, 118, 121, 126, 133, 142,
    153, 166, 181, 198, 49, 50, 53, 58, 65, 74, 85, 98, 113, 130, 50, 51, 54,
    59, 66, 75, 86, 99, 114, 131, 53, 54, 57, 62, 69, 78, 89, 102, 117, 134,
    58, 59, 62, 67, 74, 83, 94, 107, 122, 139, 65, 66, 69, 74, 81, 90, 101,
    114, 129, 146, 74, 75, 78, 83, 90, 99, 110, 123, 138, 155, 85, 86, 89, 94,
    101, 110, 121, 134, 149, 166, 98, 99, 102, 107, 114, 123, 134, 147, 162,
    179, 113, 114, 117, 122, 129, 138, 149, 162, 177, 194, 130, 131, 134, 139,
    146, 155, 166, 179, 194, 211, 64, 65, 68, 73, 80, 89, 100, 113, 128, 145,
    65, 66, 69, 74, 81, 90, 101, 114, 129, 146, 68, 69, 72, 77, 84, 93, 104,
    117, 132, 149, 73, 74, 77, 82, 89, 98, 109, 122, 137, 154, 80, 81, 84, 89,
    96, 105, 116, 129, 144, 161, 89, 90, 93, 98, 105, 114, 125, 138, 153, 170,
    100, 101, 104, 109, 116, 125, 136, 149, 164, 181, 113, 114, 117, 122, 129,
    138, 149, 162, 177, 194, 128, 129, 132, 137, 144, 153, 164, 177, 192, 209,
    145, 146, 149, 154, 161, 170, 181, 194, 209, 226, 81, 82, 85, 90, 97, 106,
    117, 130, 145, 162, 82, 83, 86, 91, 98, 107, 118, 131, 146, 163, 85, 86,
    89, 94, 101, 110, 121, 134, 149, 166, 90, 91, 94, 99, 106, 115, 126, 139,
    154, 171, 97, 98, 101, 106, 113, 122, 133, 146, 161, 178, 106, 107, 110,
    115, 122, 131, 142, 155, 170, 187, 117, 118, 121, 126, 133, 142, 153, 166,
    181, 198, 130, 131, 134, 139, 146, 155, 166, 179, 194, 211, 145, 146, 149,
    154, 161, 170, 181, 194, 209, 226, 162, 163, 166, 171, 178, 187, 198, 211,
    226, 243};
const unsigned int len_sums_of_squares = sizeof(sums_of_squares) / sizeof(sums_of_squares[0]);

unsigned int happiness[] = {0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0,
    0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0,
    0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
    0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0,
    1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0,
    0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1,
    0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,
    0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
    0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0,
    0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1,
    0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0,
    0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,
    0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0,
    0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0,
    1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0,
    0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0,
    0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
    0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
    0, 0, 0, 0, 0, 1, 0};
const unsigned int len_happiness = sizeof(happiness) / sizeof(happiness[0]);

unsigned int calc_sum_of_squares(unsigned int num) {
    unsigned int sum = 0;
    while(num > 0) {
        unsigned int digit = num % 10;
        num /= 10;
        sum += (digit * digit);
    }
    return sum;
}

void fill_sums_of_squares() {
    for(unsigned int i = 0; i < len_sums_of_squares; i++)
        sums_of_squares[i] = calc_sum_of_squares(i);
}

unsigned int sum_of_squares(unsigned int num) {
    unsigned int sum = 0;
    while(num > 0) {
        unsigned int digits = num % len_sums_of_squares;
        num /= len_sums_of_squares;
        sum += sums_of_squares[digits];
    }
    return sum;
}

void fill_happiness() {
    happiness[0] = 0;
    for(unsigned int i = 1; i < len_happiness; i++) {
        unsigned int num = i;
        while(num > 1 && num != 89)
            num = sum_of_squares(num);
        happiness[i] = (num == 1);
    }
}

unsigned int is_happy(unsigned int num) {
    while(num >= len_happiness)
        num = sum_of_squares(num);

    return happiness[num];
}

void *worker(void *work) {
    unsigned int happy_count = 0;
    unsigned int start = (unsigned int)work, end = (start + THREAD_WORK);
    for(unsigned int i = start; i < end; i++)
        happy_count += is_happy(i);
    pthread_exit((void *)(uintptr_t)happy_count);
}

int main(void) {
    pthread_t threads[NUM_THREADS];
    pthread_attr_t attr;
    int rc;
    pthread_attr_init(&attr);
    pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_JOINABLE);

#ifndef PRECOMPUTED
    fill_sums_of_squares();
    fill_happiness();
#endif

    for(unsigned int i = 0; i < NUM_THREADS; i++)
        rc = pthread_create(&threads[i], &attr, worker, (void *)(uintptr_t)(i * THREAD_WORK));

    unsigned int happy_count = 0;
    void *rv;
    for(unsigned int i = 0; i < NUM_THREADS; i++) {
        rc = pthread_join(threads[i], &rv);
        happy_count += (unsigned int)rv;
    }

    printf("Found %u happy numbers out of %u\n", happy_count, MAX_WORK);

    pthread_exit(NULL);
}

